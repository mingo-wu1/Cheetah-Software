# 四足机器人浮动基模型

浮动基模型经典的应用场景是空间机器人，当采用《刚体动力学》中的计算方法时，模型的推导缺少中文的材料。这里结合四足机器人的浮动基模型的代码，介绍浮动基模型的设计。

## 建立四足机器人浮动基模型

```
Quadruped<T>::buildModel()
```

**创建浮动基base**

```
FloatingBaseModel::addBase()
```

自由度$_nDof=6$

前6个自由度父构件为0（即没有父构件）

自由度0-5减速度为0（即没有减速），自由度6为1（即真实速度）

自由度0-5类型为为Nothing（即没有关节），自由度6为JointType::FloatingBase（即浮动基）

0-6自由度绕动轴为X（由于没有关节，因此实际无效）

自由度0-5惯量为0（即认为不存在构件），自由度6为Base的惯量（即浮动基的惯量）

构件1的关节1到关节2的变换矩阵为单位阵（即不发生坐标系转换）

构件5称为浮动基

解释：由于前6个自由度是Base的，将第6个自由度看成构件Base，前5个自由度没有构件。因此

**创建浮动基的接触模型（盒子）**

```
FloatingBaseModel::addGroundContactBoxPoints()
```
添加八个非足端点的接触模型。

**创建四条腿**


计算Base到Abad构件关节的变换矩阵

加入Abad构件（考虑正反方向）

计算Abad到Hip构件关节的变换矩阵

加入Hip构件（考虑正反方向）

对Hip关节的末端，也就是Knee关节处添加接触点

计算Hip到Knee构件关节的变换矩阵

加入Knee构件（考虑正反方向）

对Knee关节的末端，也就是足端处添加接触点

**加入重力加速度**

```
FloatingBaseModel::setGravity()
```



# 四足机器人模型更新

## 正向运动学

```
FloatingBaseModel::forwardKinematics()
```

计算变换矩阵；

计算构件速度；

计算坐标系旋转产生的加速度$C = V_{i}^{J} \times V_{i}$

类似的，计算转子的变换矩阵、转子速度和加速度

## 偏置加速度计算

```
FloatingBaseModel::biasAccelerations()
```

计算偏置加速度，将构件i-1的加速度变换到构件i上，并加上$C$。

## 计算惯性矩阵

```
FloatingBaseModel::compositeInertias()
```

每一个构件的惯性矩阵，都是以其自身为根节点的整根树的惯性矩阵合效果。

## 前向加速度运动学

```
FloatingBaseModel::forwardAccelerationKinematics()
```

计算包括重力加速度在内的显示加速度项。（将速度因坐标系变换产生的加速度，认为是隐式加速度）

## 接触雅可比矩阵

```
FloatingBaseModel<T>::contactJacobians()
```

构造接触雅可比矩阵$J_{c}$。接触雅可比矩阵反映的是接触点作用力向各关节上的映射。

构造一阶分量$\dot{J}_{c}\dot{q}$，反映的是一阶分量产生的加速度。

## 计算重力作用

```
FloatingBaseModel<T>::generalizedGravityForce()
```

计算每一个构件的关节受到的重力影响（重力来自于以构件i为根节点的整棵子树）

## 计算由一阶项产生的作用力（应该是科氏力加向心力）

```
FloatingBaseModel<T>::generalizedCoriolisForce()
```

核心计算公式是$f = Ia + V\times^{*}Iv$

## 计算质量矩阵

```
FloatingBaseModel<T>::massMatrix()
```

构造力平衡公式的系数矩阵A

## 计算反向动力学（由运动计算作用力）

通过关节运动的情况反向计算关节力矩，和广义力平衡公式的本质是一样的，只是没有写成标准形式。





## 构造浮动基模型所用相关函数

**创建接触点**

```
FloatingBaseModel::addGroundContactPoint()
```

确定接触点所在构件

确定接触点在构件相对坐标

足端位置和速度pGC和vGC初值为0

加入接触雅可比序列，$J_{c,3\times 6}$

加入$\dot{J}\dot{q}_{3\times1}$

需要计算接触信息

加入足端碰撞点在碰撞点中的序列号

令足端需要计算接触信息（所以实际上所有接触点都需要计算碰撞了）

重构参数矩阵大小

**创建构件**

```
FloatingBaseModel::addBody()
```

添加父构件

添加关节减速比

添加关节类型

添加关节运动轴

添加连杆两端变换矩阵

添加转子变换矩阵

添加构件惯性矩阵

添加转子惯性矩阵

自由度+1