# 状态观测器解析

## 状态观测器方程



<img src="D:\Dog\stateEstimator\SE.png" alt="SE" style="zoom:33%;" />

## 标准状态方程

系统的标准状态方程，反映了设计者关心的参数的变化规律，通常时由连续状态方程离散化，或者直接建立离散状态方程获得的。

系统状态方程：
$$
{x_{k }} = A{x_{k-1} }+ B{u_k} + {w_k}
$$


$$
{y_k} = C{x_k} + {v_k}
$$

其中$u_k$$w_k$ 是过程噪声，$v_k$ 是测量噪声。

## 状态观测器

由于系统的真实状态是无法直接获取的，因此我们需要一个状态观测方程（状态观测器）。状态观测器的输出是我们能够直接测量得到的值（测量值），状态量是系统的估计值。如公式$\ref{观测器状态方程},\ref{观测器输出方程}$。

状态观测器方程：
$$
{\widehat x_{k}}=A{{\widehat x_{k -1}}}+Bu_k+Kg_k(y_k-\widehat y_{k}) \label{观测器状态方程}
$$


$$
\widehat y_k=C\widehat x_k \label{观测器输出方程}
$$

### 将设计者关心的系统参数作为状态方程的系统状态值

状态量是世界坐标系下质心位置、质心速度、4条腿足端的位置：
$$
x = {\left[ {\begin{array}{*{20}{c}}
{{p_{com}}}\\
{{v_{com}}}\\
{p_1}\\
{p_2}\\
{p_3}\\
{p_4}
\end{array}} \right]_{18 \times 1}}
$$
质心位置和速度满足以下状态方程（采用一阶线性化）：
$$
p_{com,k}=p_{com,k-1}+v_{com,k-1}dt
$$

$$
v_{com,k}=v_{com,k-1}+a_kdt
$$

其中加速度为imu测量值加上重力加速度,为系统输入：
$$
a_k=a_{imu}+\left[ {\begin{array}{*{20}{c}}
0\\
0\\
{ - 9.8}
\end{array}} \right]
$$
是因为imu的Z向加速度为+9.8吗？

因此系统状态方程中A、B矩阵表达式为：
$$
A = {\left[ {\begin{array}{*{20}{c}}
{{I_3}}&{{I_3}dt}&{}\\
{}&{{I_3}}&{}\\
{}&{}&{{I_{12}}}
\end{array}} \right]_{18 \times 18}}
$$

$$
B = {\left[ {\begin{array}{*{20}{c}}
{{0_3}}\\
{{I_3}dt}\\
{0}
\end{array}} \right]_{18 \times 3}}
$$

整体表达式：
$$
{\left[ {\begin{array}{*{20}{c}}
{{p_{com}}}\\
{{v_{com}}}\\
{p_1}\\
{p_2}\\
{p_3}\\
{p_4}
\end{array}} \right]^{k+1}_{18 \times 1}} = {\left[ {\begin{array}{*{20}{c}}
{{I_3}}&{{I_3}dt}&{}\\
{}&{{I_3}}&{}\\
{}&{}&{{I_{12}}}
\end{array}} \right]^{k}_{18 \times 18}}

{\left[ {\begin{array}{*{20}{c}}
{{p_{com}}}\\
{{v_{com}}}\\
{p_1}\\
{p_2}\\
{p_3}\\
{p_4}
\end{array}} \right]^{k}_{18 \times 1}}

+

{\left[ {\begin{array}{*{20}{c}}
{{0_3}}\\
{{I_3}dt}\\
{0}
\end{array}} \right]^{k}_{18 \times 3}}

a_{3\times 1}

+

{w_k}
$$
注意：仅从目前上式的功能看，并不需要下半截的12行。

### 将传感器能够检测出来的作为观测器的输出值

系统输出为世界坐标系下四个足端相对于质心分别的位置、质心相对于足端的速度，以及四条腿足端的垂直方向的高度：
$$
y = {\left[ {\begin{array}{*{20}{c}}
{ - {p_{f12 \times 1}}}\\
{{v_{s12 \times 1}}}\\
{pz{s_{4 \times 1}}}
\end{array}} \right]_{28 \times 1}} \label{输出方程}
$$
定义$p_{rel} = p_h + p_i$，其中$p_h$是肩部的转轴相对于质心的向量，本体坐标系。$p_i$是足端位置相对于肩部的位置，本体坐标系。因此$p_{rel}$是足端相对于质心的位置在本体的表达。

定义$p_f = R_{body} \cdot p_{real}$，得到世界坐标系下的足端相对质心的位置。

编者注：存在的问题是，$y$并非可以直接观测得到啊。

## 状态观测器的构造

根据车身角速度以及旋转矩阵可以得到世界坐标系下足端相对于质心的速度$dp_f=R_{body}(\omega \times p_{rel}+dp_{rel})$ 。

需要解决的问题是，对于足端而言，摆动过程和触地过程是不一样的。将公式$\ref{输出方程}$展开有：
$$
{\left[ {\begin{array}{*{20}{c}}
{ - {p_{f12 \times 1}}}\\
{{v_{s12 \times 1}}}\\
{pz{s_{4 \times 1}}}
\end{array}} \right]^{k}_{28 \times 1}} =

{\rm{  }}\left[ {\begin{array}{*{20}{c}}
{{I_{\rm{3}}}}&{}&{{\rm{ - }}{I_{\rm{3}}}}&{}&{}&{}\\
{{I_{\rm{3}}}}&{}&{}&{{\rm{ - }}{I_{\rm{3}}}}&{}&{}\\
{{I_{\rm{3}}}}&{}&{}&{}&{{\rm{ - }}{I_{\rm{3}}}}&{}\\
{{I_{\rm{3}}}}&{}&{}&{}&{}&{{\rm{ - }}{I_{\rm{3}}}}\\
{}&{{I_{\rm{3}}}}&{}&{}&{}&{}\\
{}&{{I_{\rm{3}}}}&{}&{}&{}&{}\\
{}&{{I_{\rm{3}}}}&{}&{}&{}&{}\\
{}&{{I_{\rm{3}}}}&{}&{}&{}&{}\\
{}&{}&{\left[ {\begin{array}{*{20}{c}}
{\rm{0}}&{\rm{0}}&{\rm{1}}
\end{array}} \right]}&{}&{}&{}\\
{}&{}&{}&{\left[ {\begin{array}{*{20}{c}}
{\rm{0}}&{\rm{0}}&{\rm{1}}
\end{array}} \right]}&{}&{}\\
{}&{}&{}&{}&{\left[ {\begin{array}{*{20}{c}}
{\rm{0}}&{\rm{0}}&{\rm{1}}
\end{array}} \right]}&{}\\
{}&{}&{}&{}&{}&{\left[ {\begin{array}{*{20}{c}}
{\rm{0}}&{\rm{0}}&{\rm{1}}
\end{array}} \right]}
\end{array}} \right]^{k}

{\left[ {\begin{array}{*{20}{c}}
{{p_{com}}}\\
{{v_{com}}}\\
{p_1}\\
{p_2}\\
{p_3}\\
{p_4}
\end{array}} \right]^{k}_{18 \times 1}}
$$
基于各变量的定义，
$$
-p_f = p_{com} - p_1\\
p_1 = P_{com} + p_f
$$
符合定义。但是对于速度项而言，摆动腿和支撑腿有显著的区别（0或非0）。

如果系统是完全准确的，则无论触地还是摆动阶段，$-dp_f$都是质心相对于足端的速度（定义决定）。但是触地时，质心相对于足端的速度就是质心的速度。直接用该值显然比求分为的精度高。而摆动时，则选择用$-dp_f$表示。以上说明意味着，观测器的方程虽然

定义接触状态参数$contactEstimate$，该参数表示的是指，足端进入了触地段，并且相对于触地的总时长的占比。刚进入触地时该值为0，刚离开触地时该值为1，进入摆动后该值又为0。

再设定了一个置信窗$trust\_window$，一个置信值$trust$

有
$$
\begin{array}{rl}
&IF~~ contactEstimate < trust\_window\\
&~~~~~~~trust = \frac{contactEstimate}{trust\_window}\\
&ELIF~~  contactEstimate > 1 - trust\_window\\
&~~~~~~~trust = \frac{1 - contactEstimate}{trust\_window}\\
&ELSE~~ trust = 1
\end{array}
$$
通过上式，可以让$trust$从足端进入接触状态到离开接触状态这段过程中，从0-1-0，梯形变化。

基于上述梯形变化，质心相对于世界坐标系的速度为：
$$
v_s=(1-trust)v_{com}-trust \cdot dp_f \label{质心相对于足端的速度}
$$
其中$trust$ 与接触相位相关，$trust=0$ 未接触，$trust=1$ 接触，足端高度估计也与$trust$ 相关：

编者注：如果采用上式，则并不满足观测器方程了，这一部分该如何解释？亦或者对于非触底腿不做考量？

下面解释为什么要写成上式。当足端触地的时候，认为足端位移和速度为零，此时足端和质心的相对位置关系能够准确反映真实的质心速度，此时质心的速度$v_s$就是$-dp_f$，（足端速度为零时，相对速度就是质心的真实速度）。而当足端未触地时，
$$
pzs=(1-trust)(p_{com}(3)+p_f(3)) \label{足端高度}
$$
对上式解释：当完全触地的时候，抬腿高度就是0，当完全抬起的时候，就是$p_{com}(3)+p_f(3)$。中间过程设计为线性过渡段。

因此公式$\ref{质心相对于足端的速度}$和公式$\ref{足端高度}$使用trust这个量，实现了足端的摆动腿和非摆动腿的区分（摆动的时候等式恒成立，非摆动的时候用四条腿算出来的质心速度对理论值求解误差）。

C矩阵形式：
$$
C{\rm{ = }}\left[ {\begin{array}{*{20}{c}}
{{I_{\rm{3}}}}&{}&{{\rm{ - }}{I_{\rm{3}}}}&{}&{}&{}\\
{{I_{\rm{3}}}}&{}&{}&{{\rm{ - }}{I_{\rm{3}}}}&{}&{}\\
{{I_{\rm{3}}}}&{}&{}&{}&{{\rm{ - }}{I_{\rm{3}}}}&{}\\
{{I_{\rm{3}}}}&{}&{}&{}&{}&{{\rm{ - }}{I_{\rm{3}}}}\\
{}&{{I_{\rm{3}}}}&{}&{}&{}&{}\\
{}&{{I_{\rm{3}}}}&{}&{}&{}&{}\\
{}&{{I_{\rm{3}}}}&{}&{}&{}&{}\\
{}&{{I_{\rm{3}}}}&{}&{}&{}&{}\\
{}&{}&{\left[ {\begin{array}{*{20}{c}}
{\rm{0}}&{\rm{0}}&{\rm{1}}
\end{array}} \right]}&{}&{}&{}\\
{}&{}&{}&{\left[ {\begin{array}{*{20}{c}}
{\rm{0}}&{\rm{0}}&{\rm{1}}
\end{array}} \right]}&{}&{}\\
{}&{}&{}&{}&{\left[ {\begin{array}{*{20}{c}}
{\rm{0}}&{\rm{0}}&{\rm{1}}
\end{array}} \right]}&{}\\
{}&{}&{}&{}&{}&{\left[ {\begin{array}{*{20}{c}}
{\rm{0}}&{\rm{0}}&{\rm{1}}
\end{array}} \right]}
\end{array}} \right]
$$
过程中噪声的协方差矩阵$Q$ 为：
$$
Q = {\left[ {\begin{array}{*{20}{c}}
{\frac{{dt}}{{20}} \cdot noise\_pimu \cdot {I_3}}&{}&{}&{}&{}&{}\\
{}&{\frac{{9.8dt}}{{20}} \cdot noise\_vimu \cdot {I_3}}&{}&{}&{}&{}\\
{}&{}&{Q1}&{}&{}&{}\\
{}&{}&{}&{Q2}&{}&{}\\
{}&{}&{}&{}&{Q3}&{}\\
{}&{}&{}&{}&{}&{Q4}
\end{array}} \right]_{18 \times 18}}
\\Qi=(1+(1-trust(i))\cdot h)\cdot noise\_pfoot\cdot dt\cdot I_3
$$
测量噪声协方差矩阵$R$ 为：
$$
R = {\left[ {\begin{array}{*{20}{c}}
{s\_n\_pimu \cdot {I_{12}}}&{}&{}&{}&{}&{}\\
{}&{R1}&{}&{}&{}&{}\\
{}&{}&{R2}&{}&{}&{}\\
{}&{}&{}&{R3}&{}&{}\\
{}&{}&{}&{}&{R4}&{}\\
{}&{}&{}&{}&{}&{(1 + (1 - {\rm{trust(i)}} \cdot {\rm{h}})) \cdot s\_n\_z \cdot {I_4}}
\end{array}} \right]_{28 \times 28}}\\
Ri=(1+(1-trust(i))\cdot h)\cdot s\_n\_vimu\cdot I_3
$$
$s\_n\_pimu$ 是指senor_noise_pimu_rel_foot，与足端位置信息相关的传感器噪声协方差,$s\_n\_vimu$ 指senor_noise_vimu_rel_foot，与足端速度信息相关的传感器噪声协方差，$s\_n\_z$ 是sensor_noise_zfoot，与足端高度相关的传感器噪声协方差，在程序中均为给定值。

 基于上一时刻状态计算得到的此刻状态为：
$$
\widehat x_{k|k-1}=A\widehat x_{k-1}+Bu_k
$$
对应的协方差矩阵：
$$
P_{k|k-1}=AP_{k-1}A^T+Q
$$
结合估算值与根据输出的误差得到的测量值，得到最优估计值：
$$
\widehat x_{k}=\widehat x_{k|k-1}+Kg_k(y_k-C\widehat x_{k|k-1})
$$
其中$Kg_k$ 是卡尔曼增益：
$$
Kg={P_{k|k-1}C^T}{(CP_{k|k-1}C^T+R)^{-}}
$$
写成分式的形式，不符合矩阵的表达规范。如下就是错误的表达。
$$
Kg=\frac{P_{k|k-1}C^T}{CP_{k|k-1}C^T+R}
$$
更新协方差矩阵：
$$
P_k=(I-Kg_k\cdot C)P_{k|k-1}
$$
为保证协方差矩阵$P_k$ 始终是对称矩阵，执行以下计算：
$$
P_k=\frac{P_k+P_k^T}{2}
$$
在程序末端有一段对协方差矩阵中关于质心位置的协方差行列式的判断，当$P_k$ 前3行3列矩阵行列式大于0.000001时，将协方差矩阵中与质心x和y相关的行和列重新赋值（减小协方差矩阵中的值），由于实体机中计算精度到小数点后六位，可认为在行列式值大于0的情况下，即对角线上3个元素全不为0，其中行列式判断阈值决定了对模型的可信度，将阈值调大，则状态量观测值更倾向于修正值，将阈值调小则状态观测值更倾向于模型预测值。

## 卡尔曼增益矩阵推导

模型预测状态与真实状态之间的协方差矩阵$[\widehat x_{k|k-1}-x_k][\widehat x_{k|k-1}-x_k]^T$为$P_k$ 

状态向量的最优估计值$\widehat x_{k}=\widehat x_{k|k-1}+Kg_k(y_k-C\widehat x_{k|k-1})$ ,最优估计状态值与真实状态值之差为：
$$
\begin{array}
\\\widehat x_{k}-x_k &=\widehat x_{k|k-1}-x_k+Kg_k(Cx_k+v_k-C\widehat x_{k|k-1})\\
 & =(I-Kg_kC)(\widehat x_{k|k-1}-x_k)+Kg_kv_k
 \end{array}
$$
最优估计值和真实值误差向量的协方差矩阵$\widehat P$为：
$$
\begin{array}
\\\widehat P_k&=(I-Kg_kC)[\widehat x_{k|k-1}-x_k][\widehat x_{k|k-1}-x_k]^T(I-Kg_kC)^T+Kg_kRKg_k^T
\\&=(I-Kg_kC)P_{k|k-1}(I-Kg_kC)^T+Kg_kRKg_k^T
 \end{array}
$$
为使估计效果最好，卡尔曼增益矩阵的选值为使误差向量协方差矩阵最小，即$\frac{\partial \widehat P_k}{\partial Kg_k}=0$ 。

为方便理解，针对矩阵求导问题进行推导，主要对$F1=XHX^T$ 和$F2=XH$ 对$X$ 求导问题进行推导。

对于函数$F1=XHX^T$,写成张量形式有：
$$
F1=F1_{i,j}e_ie_j=X_{i,k}H_{k,l}X_{j,l}e_ie_j
$$
对矩阵$X=X_{p,q}e_pe_q$ 进行求导有：
$$
\begin{array}
\\\frac{\partial F1}{\partial X}&=\frac{\partial F1_{i,j}}{\partial X_{p,q}}e_ie_j
\\&=\frac {\partial X_{i,k}H_{k,l}X_{j,l}}{X_{p,q}}e_ie_je_pe_q
\\&=2X_{i,m}H_{m,n}e_ie_n
\\&=2XH
 \end{array}
$$
同样，对于$ \frac{\partial F2}{\partial X} $ 的形式进行推导：
$$
\begin{array}\\\frac{\partial F2}{\partial X}&=\frac{\partial F2_{i,j}}{\partial X_{p,q}}e_ie_j\\&=\frac {\partial X_{i,k}H_{k,j}}{X_{p,q}}e_ie_je_pe_q\\
&=H_{k,j}e_je_k\\&=H^T \end{array}
$$
因此协方差矩阵对增益矩阵求导为：
$$
\begin{array}\\
\frac{\partial \widehat P}{\partial Kg_k}&=-2(I-Kg_kC)P_{k|k-1}C^T+2Kg_kR
\\&=2(CP_{k|k-1}C^T+R)Kg_k-2P_{k|k-1}C^T

\end{array}\label{公式28}
$$
令上式为0，则可得到卡尔曼增益矩阵的表达式：
$$
Kg_k=\frac{P_{k|k-1}C^T}{CP_{k|k-1}C^T+R}
$$

## 状态观测器调整算法：

1更改R矩阵的值

```C++
   //add by anli
   // R(rindex1，rindex1) = T(0.001) * R(rindex1，rindex1);
    R(rindex2, rindex2) = T(0.001) * R(rindex2, rindex2);
    //add end
//
```

调试记录：

将x的senor noise vimu乘上0.001后能够将后退问题从10s25cm降到10s4cm，仿真上继续改小可以观测到减小后退，但是继续改小实体机上会出现数值计算问题，会报计算错误，

matlab仿真显示加速度做偏移影响较小。

宇树踏步前进15cm

- 是否加偏移量？？？
- 状态观测器下一步做什么呢？??

