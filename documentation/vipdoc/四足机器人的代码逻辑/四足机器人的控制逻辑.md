# 四足机器人的控制逻辑

## 启动

核心代码块

```
//RobotRunner.cpp Line113
if( (rc_control.mode == 0) && controlParameters->use_rc ) {
        //这一块的读入是否是有问题的？（之前看是遥控器读取有问题）
      if(count_ini%1000 ==0)   printf("ESTOP!\n");
      for (int leg = 0; leg < 4; leg++) {
        _legController->commands[leg].zero();
      }
      _robot_ctrl->Estop();
```

当用户设置use_rc为1时，cheetah始终处于关节无使能的状态，

当用户设置use_rc为0时，进入cheetah的初始化。

## 初始化

四肢会从当前姿态，通过贝塞尔曲线逐渐走到target_jpos。该部分的参数在下面的文件中定义的。

```
#config/initial_jpos_ctrl.yaml
```

这段轨迹是走的**位置环**。

## 各种模式

### K_BALANCE_STAND 平衡站立

模式功能：站立下的姿态扭动。

平衡站立模式下，默认四个足端都是触地状态（不发生位移），通过WBC实现姿态的扭动。

### K_RECOVERY_STAND 恢复站立模式

模式功能：将跌倒或翻转的cheetah恢复到正常的站立状态，均使用

1. 判断cheetah是否翻转，若翻转，进入2；若未翻转，进入3

2. 将一侧两条腿收缩，将另一侧两条腿向下踹，使狗子完成翻身；

3. 将两条腿按照贝塞尔曲线收缩至身下；

4. 将腿伸直，完成站立。#位置环的PD控制

### K_LOCOMOTION 运动模式
模式功能：基于多种运动步态进行移动
运动模式下的理论包括足端规划，MPC计算足端作用力和WBC优化，这三块内容需要逐一说明。

**足端规划**

1. 足端规划的是四肢末端的位置。通过状态观测器获得当前的位置；

2. 根据目标速度，计算期望的本体中心的世界坐标；

3. 将足端摆动的整个过程分为摆动过程和站立过程，通过计算摆动过程剩余时间，不断更新摆动的末端世界位置；

4. **更新MPC**

5. 根据时序计算足端是否是否触地；

6. 对于摆动过程，通过更新贝塞尔曲线，计算得到当前期望的足端世界位置；

7. 此时通过计算足端相对于该腿臀部的位置（将腿看作机械臂了）；

8. 通过位置环的PD该腿进行迈步；

9. 对于触地过程，足端世界坐标始终保持不变，其他计算方法不变；
10. 通过位置环的PD该腿进行迈步。如果开启了WBC，就把MPC的前馈加入到控制中；



**MPC**

通过单纯的足端位置控制，已经可以实现cheetah的运动。研究者为了让控制的目的性更强，希望在运动状态下，能根据实际的控制要求主动设计合适的驱动力矩，即假如动力学前馈。对于cheetah，正常运行中可以优化的外力作用只有足端的作用力，因此将足端作用力作为控制量，实现对本体的控制优化。因此，**MPC的优化目的，是在足端位置控制的计算关节力矩的时候，计算前馈作用力，提高控制精度。**

需要特别强调的是，如果没有这个足端作用力作为前馈量，力矩模式下姿态不可能保持目标位置，否则没有Error产生PD的输出，因此如果此时有前馈值，则可以确保姿态更加精准。但是由于底层仍旧是PID控制，所以任何误差的存在都会直接导致关节力矩在前馈值上叠加Error引起的控制量，从而导致系统会有波动，且该波动无法避免。

首先是要理解，构造的状态方程的物理意义
$$
x(k+1) = A_{k} x(k) + B_{k}f(k) + g
$$
这个方程的具体参数参考《MPC内容说明V1》。$x$的设计，是为了控制本体的状态，位置和速度。上式表明了当前状态下，输入的四条腿的作用力决定了下一时刻的状态。反过来，假如已知当前状态，同时设定未来时刻的状态，则可以反向求解控制量。MPC就是基于QP优化理论，将状态方程的控制量优化，转为一个标准的QP优化问题，从而解算出能够实现未来时刻的状态量。具体的MPC优化理论参考《MPC内容说明V1》。

**WBC**

仅靠**位置环的控制**、或者**在位置环上加入MPC的前馈控制方法**，分别都可以完成四足的控制。**前者提供最基本的位置PD控制，后者优化前馈量。**

在运动规划中，我们有相应的位置指令，因此**理论的速度、加速度**都是已知的。但是实际中位置Error的存在，控制品质会下降。

理论上
$$
S_{f}(A\ddot{q}_{cmd} + b + g) = S_{f} J_{c}^T f_{MPC}
$$
但是实际上由于执行、环境等带来的误差，上式需要更新为
$$
S_{f}(A(\ddot{q}_{cmd} + \delta\ddot{q}) + b + g) = S_{f} J_{c}^T (f_{MPC} + \delta f)
$$
为了提高控制品质，我们希望通过在MPC计算得到的足端作用力$f$下，对其进行微调，从而在满足上式的同时，又能够保证加速度和足端前馈作用的偏差足够小（最理想的状态是偏移量为0，但是由于实际系统的偏差，如果控制量$f$按照MPC理论计算给出，则实际的加速度相对于$\ddot{q}_{cmd}$的偏移量可能较大，导致运动状态（位置和速度）与期望值偏差较大。因此定义的性能方程：
$$
\min_{\delta \ddot{q},\delta f} = \delta_ {\ddot{q}}^T Q_{1} \delta_ {\ddot{q}} + \delta_ {f}^TQ_{1}\delta_ {f}
$$
优化的目标是，在保证前馈作用力的偏移量较小的同时，让加速度的偏移值也较小。